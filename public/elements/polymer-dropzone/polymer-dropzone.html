<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/components/paper-button/paper-button.html">
<link rel="import" href="/components/paper-progress/paper-progress.html">
<link rel="import" href="/elements/generate-uuid/generate-uuid.html">
<script src="/components/dropzone/dist/min/dropzone.min.js"></script>


<!--
`polymer-dropzone`


@demo demo/index.html
-->

<dom-module id="polymer-dropzone">
  <template>
    <style>
      :host {
        display: block;
      }
      .upload-wrapper {
        display: flex;
        flex-flow: column;
        align-items: center;
      }
      paper-button {
        background: #4285f4;
        color: #fff;
      }
      .preview {
        margin-top: 10px;
      }
      .preview img {
        height: 100px;
        width: auto;
      }
    </style>
    <div class="upload-wrapper">

      <paper-button on-tap="_openDialog">Upload Icon</paper-button>
      <input type="file" id="fileInput" on-change="_fileChange" hidden>
      <div class="preview">
        <img id="preview" class="preview">
        <paper-progress id="progress" value="[[uploadProgress]]"></paper-progress>
      </div>
  </div>

  </template>

  <script>
    Polymer({
      is: 'polymer-dropzone',
      behaviors: [__state__],
      properties: {
        user: {
          type: Object
        },
        path: {
          type: Object
        }
      },
      ready: function(){

      },
      _showPreview: function(){
        return this.uploadProgress;
      },
      _fileChange: function(e){
        if(!this.user){
          console.warn('no user specified.');
          return;
        }
        if(!this.path){
          console.warn('no path specified.');
          return;
        }
        var file = e.target.files[0];
        var reader  = new FileReader();

        reader.addEventListener("load", ()=>{
          this.$.preview.src = reader.result;
        }, false);

        if (file) {
          reader.readAsDataURL(file);
        }

        // Create a root reference
        var storageRef = firebase.storage().ref();
        var uuid = window.UUID();
        // Create a reference to 'images/mountains.jpg'
        var imageRef = storageRef.child(`${this.path}/${uuid}-${file.name}`);
        var uploadTask = imageRef.put(file);
        uploadTask.on('state_changed', snapshot => {
          // Observe state change events such as progress, pause, and resume
          // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
          var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          this.set('uploadProgress',progress);
          console.log('Upload is ' + progress + '% done');
          switch (snapshot.state) {
            case firebase.storage.TaskState.PAUSED: // or 'paused'
              console.log('Upload is paused');
              break;
            case firebase.storage.TaskState.RUNNING: // or 'running'
              console.log('Upload is running');
              break;
          }
        }, error => {
          // Handle unsuccessful uploads
        }, () => {
          // Handle successful uploads on complete
          // For instance, get the download URL: https://firebasestorage.googleapis.com/...
          var downloadURL = uploadTask.snapshot.downloadURL;
          this.fire('image-uploaded', {downloadURL, file});
        });
      },
      _openDialog: function(){
        var elem = this.$.fileInput;
        if (elem && document.createEvent) { // sanity check
          var evt = document.createEvent("MouseEvents");
          evt.initEvent("click", true, false);
          elem.dispatchEvent(evt);
        }
      },
      attached: function(){
        if (window.File && window.FileReader && window.FileList && window.Blob) {
          // Great success! All the File APIs are supported.
        } else {
          alert('The File APIs are not fully supported in this browser.');
        }
      },

    });
  </script>
</dom-module>
