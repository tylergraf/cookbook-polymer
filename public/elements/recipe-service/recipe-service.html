<script src='./recipe-service.js'></script>
<script>
(function() {
  var service = window.__services__.RecipeService;
  var _instances = [];
  var stripHTML = function(html){
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }
  var decodeHtml = function(html) {
   if (html) {
     var elem = document.createElement('div');
     elem.innerHTML = html.replace(/\t/g, "").replace(/<br\s*\/{0,1}>/gi, "\n");
     return elem.textContent;
   }
 };
  var __updatePersonObjsByPid = function(id, data) {
    _instances.filter(function(_instance) {
      return _instance.recipeId === id;
    }).forEach(function(_instance) {
      if (data) {
        _instance.recipeObj = data;
      } else {
        service.getRecipeObj(id).then(function(obj) {
          _instance.recipeObj = obj;
        });
      }
    });
  };
  service.properties = {
    recipeId: {
      type: String,
      value: '',
      observer: '__idObserver'
    },
    recipeObj: {
      type: Object,
      observer: '__recipeObjObserver'
    }
  };
  /**
   * Capture the instance that needs to be updated
   */
  service.ready = function() {
    _instances.push(this);
  };
  /**
   * Clean up `_instances` var if element detached
   */
  service.detached = function() {
    _instances = _instances.filter(function(_instance) {
      return this !== _instance;
    }.bind(this));
  };
  service.__idObserver = function(id) {
    if (!id) return;
    this.getRecipeObj(id)
      .then(function(data) {
        __updatePersonObjsByPid(id);
      })
      .catch(function(err) {
        __updatePersonObjsByPid(id, {
          id: id,
          summary: {
            "name": "UNKNOWN",
            "gender": "UNKNOWN",
            "living": true,
            "lifespan": "",
            "tombstoned": false,
            "readOnly": false,
            "sourcesCount": 0,
            "discussionsCount": 0,
          }
        });
      });
  };
  service.__recipeObjObserver = function(obj) {
    if (!obj) return;
    console.log(obj);
    this.set('recipeObj.title', decodeHtml(obj.title));
    this.set('recipeObj.subtitle', decodeHtml(obj.subtitle));
    this.set('recipeObj.directions', stripHTML(obj.directions));
    this.set('recipeObj.ingredients', obj.ingredients);
    this.set('recipeObj._id', obj._id);
  };
  var setPersonObj = service.setPersonObj;
  service.setPersonObj = function(id, data) {
    setPersonObj(id, data);
    __updatePersonObjsByPid(id);
  };
})();
</script>
