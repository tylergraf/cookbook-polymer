<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/components/paper-button/paper-button.html">
<link rel="import" href="/components/paper-listbox/paper-listbox.html">
<link rel="import" href="/components/iron-selector/iron-selector.html">
<link rel="import" href="/components/paper-item/paper-item.html">
<link rel="import" href="/components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/components/iron-input/iron-input.html">
<link rel="import" href="/components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="/components/file-upload/file-upload.html">
<link rel="import" href="/elements/polymer-dropzone/polymer-dropzone.html">
<link rel="import" href="/elements/recipe-card/recipe-card.html">

<!--
`add-recipe`


@demo demo/index.html
-->

<dom-module id="add-recipe">
  <template>
    <style>
      :host {
        display: flex;
        flex-flow: column;
        align-items: center;
      }
      label {
        display: block;
        margin-top: 10px;
      }
      input {
        height: 36px;
        font-size: 30px;
        line-height: 30px;
        font-family: 'Scope One', sans-serif;
      }
      iron-autogrow-textarea {
        background: #fff;
        line-height: 1.4rem;
        font-size: 30px;
        line-height: 30px;
        font-family: 'Scope One', sans-serif;
        border: none;
      }
      paper-button {
        background: green;
        color: #fff;
      }
      paper-item {
        cursor: pointer;
      }
      .colors {
        display: flex;
        flex-flow: wrap;
        justify-content: space-between;
      }
      .color-wrapper {
        border: 1px solid transparent;

      }
      .color {
        height: 50px;
        width: 50px;
        margin: 4px;
      }
      .color-wrapper.iron-selected {
        border-color:#333;
      }
      .blue {
        background-color: var(--blue-color);
      }
      .red {
        background-color: var(--red-color);
      }
      .yellow {
        background-color: var(--yellow-color);
      }
      .green {
        background-color: var(--green-color);
      }
      .purple {
        background-color: var(--purple-color);
      }
      .orange {
        background-color: var(--orange-color);
      }
      .icon {
        height: 50px;
        width: 50px;
        background: transparent no-repeat 0 0;
        background-size: contain;
        margin: 4px;
      }
      .icons {
        display: flex;
        flex-flow: wrap;
        justify-content: space-between;
      }
      .icon-wrapper {
        display: flex;
        flex-flow: column;
        align-items: center;
        padding: 10px;
      }
      .icon-wrapper.iron-selected .icon {
        background: #fff;
      }
    </style>
    <recipe-card  title="[[title]]"
                  description="[[description]]"
                  color="[[color]]"
                  icon="[[icon]]"
                  image-url="[[imageUrl]]"
    ></recipe-card>
    <h1>New Recipe</h1>
    <form id="newRecipeForm" on-submit="_addRecipe">
      <div>
        <label for="title">Title</label>
        <input id="title" is="iron-input" bind-value="{{title::input}}" type="text" autofocus>
      </div>
      <div>
        <label for="description">Description</label>
        <iron-autogrow-textarea rows="2" id="description" bind-value="{{description}}"></iron-autogrow-textarea>
      </div>
      <div>
        <label for="ingredients">Ingredients (each ingredient on a new line)</label>
        <iron-autogrow-textarea rows="2" id="ingredients" bind-value="{{ingredients}}"></iron-autogrow-textarea>
      </div>
      <div>
        <label for="directions">Directions (each step on a new line)</label>
        <iron-autogrow-textarea rows="2" id="directions" bind-value="{{directions}}"></iron-autogrow-textarea>
      </div>
      <div>
        <label for="image">Image</label>
        <polymer-dropzone user="[[user]]"></polymer-dropzone>
        <iron-selector id="colors" selected="0" class="colors">
          <template is="dom-repeat" items="[[colors]]" as="color">
            <div class="color-wrapper" color$="[[color]]">
              <div class$="color [[color]]"></div>
            </div>
          </template>
        </iron-selector>
        <iron-selector id="icons" selected="0" class="icons">
          <template is="dom-repeat" items="[[icons]]" as="icon">
            <div class="icon-wrapper" id="[[icon.id]]" url$="[[icon.imageUrl]]">
              <div class="icon" style$="background-image:url('[[icon.imageUrl]]')"></div>
              <p>[[icon.name]]</p>
            </div>
          </template>
        </iron-selector>

        <!-- <input id="image" is="iron-input" bind-value="{{imageUrl}}" type="text"> -->
      </div>
      <div>
        <paper-dropdown-menu label="Category" disabled$="[[!categories.length]]" vertical-align="bottom" horizontal-align="left" on-iron-select="_categorySelected">
          <paper-listbox class="dropdown-content">
            <template is="dom-repeat" items="[[categories]]" as="category">
              <paper-item value="[[category.id]]">[[category.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div>
        <paper-dropdown-menu id="subcategoryList" label="Subcategory" disabled$="[[!subcategories.length]]" vertical-align="bottom" horizontal-align="left" on-iron-select="_subcategorySelected">
          <paper-listbox class="dropdown-content">
            <template is="dom-repeat" items="[[subcategories]]" as="subcategory">
              <paper-item value="[[subcategory.id]]">[[subcategory.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <paper-button on-tap="_addRecipe">Save</paper-button>
    </form>
  </template>

  <script>
    Polymer({
      is: 'add-recipe',
      behaviors: [__state__],
      properties: {
        user: {
          type: Object,
          statePath: 'user'
        },
        categoryId: {
          type: String,
          statePath: 'categoryId',
          observer: '_categoryIdObserver'
        },
        subcategoryId: {
          type: String,
          statePath: 'subcategoryId',
          observer: '_subcategoryIdObserver'
        },
        categories: {
          type: Object,
          statePath: 'categories'
        },
        icons: {
          type: Object,
          statePath: 'icons'
        },
        subcategories: {
          type: Object,
          statePath: 'subcategories'
        },
        newRecipe: {
          type: Object,
          value: {
            title: 'stuff'
          }
        },
        title: {
          type: String,
          value: ''
        },
        description: {
          type: String,
          value: ''
        },
        icon: {
          type: Object,
          value: {}
        },
        color: {
          type: String,
          value: ''
        },
        imageUrl: {
          type: Object,
          value: '',
          statePath: 'newRecipe.imageUrl'
        },
        colors: {
          type: Array,
          value: ['red','blue','green','yellow','purple','orange']
        }
      },
      observers: ['_recipePreview(title,description,color,icon)'],
      ready: function(){
        this.dispatch(__actions__.getCategories());
        this.dispatch(__actions__.getIcons());

        this.$.icons.addEventListener('iron-select', (e)=>{
          this.set('icon.id', e.detail.item.id);
          this.set('icon.imageUrl', e.detail.item.getAttribute('url'));
        });
        this.$.colors.addEventListener('iron-select', (e,a)=>{
          this.set('color', e.detail.item.getAttribute('color'));
        });
      },
      _recipePreview: function(title,description,color,icon){
        this.set('title',title);
        this.set('description',description);
        this.set('color',color);
        this.set('icon',icon);
        this.set('imageUrl',icon.imageUrl);
      },
      _categoryIdObserver: function(categoryId){
        let action = {
          type: 'SELECT_SUBCATEGORY'
        };

        this.dispatch(action);
        if(!categoryId) return;

        this.dispatch(__actions__.getCategory(categoryId));
      },
      _subcategoryIdObserver: function(subcategoryId){
        this.$.subcategoryList.selectIndex(0);
      },
      _categorySelected: function(e){
        var selectedItem = e.target.selectedItem;
        let action = {
          type: 'SELECT_CATEGORY',
          categoryId: selectedItem && selectedItem.value
        };

        this.dispatch(action);
      },
      _subcategorySelected: function(e){
        var selectedItem = e.target.selectedItem;
        let action = {
          type: 'SELECT_SUBCATEGORY',
          subcategoryId: selectedItem && selectedItem.value
        };

        this.dispatch(action);
      },
      _addRecipe: function(e){
        e.preventDefault();

        var newRecipe = {
          title: this.title,
          imageUrl: this.imageUrl || '',
          description: this.description,
          ingredients: this.ingredients.split('\n'),
          directions: this.directions.split('\n'),
          icon: this.icon,
          color: this.color,
          created: new Date().getTime(),
        }
        this.dispatch(__actions__.addRecipe(newRecipe, this.subcategoryId, this.user.uid));

        return false;
      },
    });
  </script>
</dom-module>
