<script src='./category-service.js'></script>
<script>
(function() {
  var service = window.__services__.CategoryService;
  var _instances = [];
  var stripHTML = function(html){
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }
  var decodeHtml = function(html) {
   if (html) {
     var elem = document.createElement('div');
     elem.innerHTML = html.replace(/\t/g, "").replace(/<br\s*\/{0,1}>/gi, "\n");
     return elem.textContent;
   }
 };
  var __updateCategoryObjsById = function(id, data) {
    _instances.filter(function(_instance) {
      return _instance.categoryId === id;
    }).forEach(function(_instance) {
      if (data) {
        _instance.categoryObj = data;
      } else {
        service.getCategoriesArr(id).then(function(obj) {
          _instance.categoryObj = obj;
        });
      }
    });
  };
  var __updateSubcategoryObjsById = function(id, data) {
    _instances.filter(function(_instance) {
      return _instance.subcategoryId === id;
    }).forEach(function(_instance) {
      if (data) {
        _instance.subcategoryObj = data;
      } else {
        service.getCategoriesArr(id).then(function(obj) {
          _instance.subcategoryObj = obj;
        });
      }
    });
  };
  service.properties = {
    categoriesArr: {
      type: Array,
      observer: '__categoriesArrObserver'
    },
    categoryId: {
      type: String,
      observer: '__categoryIdObserver'
    },
    subcategoryId: {
      type: String,
      observer: '__subcategoryIdObserver'
    },
    categoryObj: {
      type: Object,
      observer: '__categoryObjObserver'
    },
    subcategoryObj: {
      type: Object,
      observer: '__subcategoryObjObserver'
    }
  };
  /**
   * Capture the instance that needs to be updated
   */
  service.ready = function() {
    var that = this;

    if(!this.categoryId && !this.subcategoryId){
      this.getCategoriesArr()
      .then(function(data){
        data.forEach(function(c){
          c.name = decodeHtml(c.name);
        })
        that.set('categoriesArr', data);
      });
    } else {
      _instances.push(this);
    }
  };
  /**
   * Clean up `_instances` var if element detached
   */
  service.detached = function() {
    _instances = _instances.filter(function(_instance) {
      return this !== _instance;
    }.bind(this));
  };
  service.__categoryIdObserver = function(id) {
    if (!id) return;
    this.getCategory(id)
      .then(function(data) {
        __updateCategoryObjsById(id, data);
      })
      .catch(function(err) {
        __updateCategoryObjsById(id, {
          id: id,
          summary: {
            "name": "UNKNOWN",
            "gender": "UNKNOWN",
            "living": true,
            "lifespan": "",
            "tombstoned": false,
            "readOnly": false,
            "sourcesCount": 0,
            "discussionsCount": 0,
          }
        });
      });
  };
  service.__subcategoryIdObserver = function(id) {
    if (!id) return;
    this.getSubcategory(id)
      .then(function(data) {
        __updateSubcategoryObjsById(id, data);
      })
      .catch(function(err) {
        __updateCategoryObjsById(id, {
          id: id,
          summary: {
            "name": "UNKNOWN",
            "gender": "UNKNOWN",
            "living": true,
            "lifespan": "",
            "tombstoned": false,
            "readOnly": false,
            "sourcesCount": 0,
            "discussionsCount": 0,
          }
        });
      });
  };
  service.__categoriesArrObserver = function(obj) {
    if (!obj) return;
    console.log(obj);
    this.set('categoriesArr.title', obj.title);
    this.set('categoriesArr.subtitle', obj.subtitle);
    this.set('categoriesArr.directions', stripHTML(obj.directions));
    this.set('categoriesArr.ingredients', obj.ingredients);
    this.set('categoriesArr._id', obj._id);
  };
  service.__categoryObjObserver = function(obj) {
    if (!obj) return;
    console.log(obj);
    obj.subcategories.forEach(function(s){
      s.name = decodeHtml(s.name);
    })
    this.set('categoryObj', obj);
  };
  service.__subcategoryObjObserver = function(obj) {
    if (!obj) return;
    console.log(obj);
    obj.recipes.forEach(function(r){
      r.title = decodeHtml(r.title);
    })
    this.set('subcategoryObj', obj);
  };
  var setPersonObj = service.setPersonObj;
  service.setPersonObj = function(id, data) {
    setPersonObj(id, data);
    __updateCategoryObjsById(id);
  };
})();
</script>
