<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/elements/app-state/app-state.html">
<link rel="import" href="/components/app-layout/app-header/app-header.html">
<link rel="import" href="/components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/components/app-route/app-location.html">
<link rel="import" href="/components/app-route/app-route.html">
<link rel="import" href="/components/iron-pages/iron-pages.html">
<link rel="import" href="/elements/search-bar/search-bar.html">
<link rel="import" href="/elements/sign-in/sign-in.html">
<link href="https://fonts.googleapis.com/css?family=Scope+One" rel="stylesheet">


<dom-module id="my-app">
  <template>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    <app-route
        route="{{route}}"
        pattern="/recipe"
        tail="{{recipeSubroute}}"></app-route>

      <div class="page-wrapper">
        <iron-pages
            selected="[[page]]"
            attr-for-selected="name"
            fallback-selection="view404"
            role="main">
          <categories-page name="categories"></categories-page>
          <category-page name="category" route="[[subroute]]"></category-page>
          <subcategory-page name="subcategory" route="[[subroute]]"></subcategory-page>
          <recipe-router name="recipe" route="[[recipeSubroute]]"></recipe-router>
          <favorites-page name="favorites" route="[[subroute]]"></favorites-page>
          <results-page name="results" route="[[subroute]]"></results-page>
          <admin-page name="admin" route="[[subroute]]"></admin-page>
          <my-view404 name="view404"></my-view404>
        </iron-pages>
      </div>
  </template>

  <script>
    Polymer({
      is: 'my-app',

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },
        id: {
          type: String,
          reflectToAttribute: true
        },
        recipeId: {
          type: String
        },
        categoryId: {
          type: String
        },
        subcategoryId: {
          type: String
        },
        navigate: {
          type: String,
          statePath: 'main.navigate',
          observer: '_navigateObserver'
        }
      },

      behaviors: [__state__],
      observers: [
        '_routeChange(route)',
        '_routePageChanged(routeData.page)',
        '_routePageChanged(routeData.page, routeData.id)'
      ],

      _routeChange: function({path}) {
        this.fire('iron-signal', {name: 'track-page', data: { path} });
      },
      _routePageChanged: function(page, id) {
        console.log('page', page);
        console.log('id', id);
        if(id){
          this[`${page}Id`] = id;
        }
        this.page = page || 'categories';
      },

      _pageChanged: function(page) {
        if(!page.includes('results')){
          this.dispatch({type: 'SET_SEARCH_BAR_OPEN', showing: false});
          this.dispatch({type: 'SET_SEARCH_QUERY', query: ''});
        }
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl( `${page}-page.html`);
        if(page === 'recipe'){
          resolvedPageUrl = this.resolveUrl('recipe-router.html')
        }
        this.importHref(resolvedPageUrl, null, this._showPage404, true);
      },
      _navigateObserver: function(href) {
        if(!href) return;
        this.set('route.path', href);
        this.dispatch({type: 'CLEAR_NAVIGATION'});
      },

      _showPage404: function() {
        this.page = 'view404';
      },
      attached: function(){
        setTimeout(()=>{
          document.querySelector('svg').remove();
        },5000);
      }
    });
  </script>
</dom-module>
