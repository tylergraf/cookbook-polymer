<link rel="import" href="/components/polymer/polymer.html"><link rel="import" href="/components/iron-selector/iron-selector.html"><link rel="import" href="/elements/recipe-card/recipe-card.html"><link rel="import" href="/elements/icon-picker/icon-picker.html"><link rel="import" href="/elements/taxonomy-path/taxonomy-path.html"><link rel="import" href="/components/paper-header-panel/paper-header-panel.html"><link rel="import" href="/components/paper-toolbar/paper-toolbar.html"><link rel="import" href="/components/app-route/app-route.html"><link rel="import" href="/elements/search-bar/search-bar.html"><dom-module id="results-page"><template><style>:host{display:block}.recipes-wrapper{display:flex;flex-flow:column}.recipes{display:flex;flex-flow:wrap;width:100%}iron-selector.recipes{width:calc(100vw - 300px)}.recipe-wrapper{width:33.333333%}recipe-card{cursor:pointer;margin:10px}recipe-card.iron-selected{border:1px solid #ccc}@media (min-width:1000px){.recipe-wrapper{width:25%}.edit .recipe-wrapper{width:30%}}@media (max-width:550px){.recipe-wrapper{width:50%}}paper-header-panel{height:90vh}[hidden]{display:none}</style><app-route route="{{route}}" pattern="/:query" data="{{routeData}}"></app-route><paper-header-panel><paper-toolbar><taxonomy-path></taxonomy-path></paper-toolbar><h2>Search Results</h2><icon-picker id="iconPicker"></icon-picker><section class="recipes-wrapper"><iron-selector id="recipeList" selected="0" class$="[[_recipesClass(edit)]]" hidden$="[[!edit]]"><template id="recipeRepeat" is="dom-repeat" items="[[recipes]]" as="recipe"><recipe-card on-click="_deleteRecipe" recipe-id="[[recipe.id]]"></recipe-card></template></iron-selector><section class="recipes" hidden$="[[edit]]"><template is="dom-repeat" items="[[recipes]]" as="recipe"><div class="recipe-wrapper"><a href="/recipe/[[recipe.id]]"><recipe-card recipe-id="[[recipe.id]]"></recipe-card></a></div></template></section></section></paper-header-panel></template><script>Polymer({
      is: 'results-page',
      behaviors: [__state__],
      properties: {
        subcategoryId: String,
        subcategory: {
          type: Object,
          statePath: 'main.subcategory'
        },
        recipes: {
          type: Object,
          statePath: 'main.recipes',
          observer: '_recipesObserver'
        },
        edit: {
          type: Boolean,
          value: false,
          observer: '_editObserver'
        },
        userId: {
          type: String,
          statePath: 'main.user.uid'
        }
      },
      observers: ['_viewChanged(routeData.query)'],
      _viewChanged: function(query){
        if(this.route.prefix.includes('/results') && query){
          this.dispatch(__actions__.runSearch(query));
        }
      },
      ready: function(){
        // this.dispatch(__actions__.getSubcategory(this.subcategoryId));
        document.addEventListener('keydown',e=>{
          if(e.keyCode === 18){
            this.delete = true;
          }
          if(e.keyCode === 27 && e.shiftKey){
            this.edit = !this.edit;
          }
        });
        document.addEventListener('keyup',e=>{
          if(e.keyCode === 18){
            this.delete = false;
          }
        });
        this.$.iconPicker.addEventListener('icon-selected',e=>{
          if(!this.edit) return;
          var recipe = Object.assign(this.selectedRecipe, {icon: e.detail});
          this.dispatch(__actions__.updateRecipe(recipe, this.userId));
        });
        this.$.iconPicker.addEventListener('color-selected',e=>{
          if(!this.edit) return;
          var recipe = Object.assign(this.selectedRecipe, {color: e.detail});
          this.dispatch(__actions__.updateRecipe(recipe, this.userId));
        });
        this.$.recipeList.addEventListener('iron-select',e=>{
          if(!this.edit) return;
          var recipe = this.$.recipeRepeat.itemForElement(e.detail.item);
          this.selectedRecipe = recipe;
          this.selectedRecipeEl = e.detail.item;
        });
      },
      _deleteRecipe: function(e, detail){
        if(this.delete){
          e.preventDefault();
          var id = e.target.id
          this.dispatch(__actions__.removeRecipe(id, this.subcategoryId));

          return false;
        }
      },
      _recipesClass: function(edit){
        if(edit){
          return 'recipes edit';
        }
        return 'recipes';
      },
      _editObserver: function(edit){
        this.$.iconPicker.open = edit;

      },
      _recipesObserver: function(e){
        console.log(e);
      },
      _addRecipe: function(e){
        e.preventDefault();
        var newRecipe = {
          title: this.title,
          imageUrl: this.imageUrl,
          description: this.description,
          ingredients: this.ingredients,
          directions: this.directions,
        }
        this.dispatch(__actions__.addRecipe(newRecipe, this.subcategoryId));
        this.newRecipe = '';

        return false;
      },
    });</script></dom-module>