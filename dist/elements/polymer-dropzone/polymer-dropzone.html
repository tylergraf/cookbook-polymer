<link rel="import" href="/components/polymer/polymer.html"><link rel="import" href="/components/paper-button/paper-button.html"><link rel="import" href="/components/paper-progress/paper-progress.html"><link rel="import" href="/elements/generate-uuid/generate-uuid.html"><link rel="import" href="../../iron-icons/iron-icons.html"><link rel="import" href="../../iron-icon/iron-icon.html"><script src="/components/dropzone/dist/min/dropzone.min.js"></script><dom-module id="polymer-dropzone"><template><style>:host{display:block}.upload-wrapper{display:flex;flex-flow:column;align-items:center}.upload-button{background:#4285f4;color:#fff}.preview{margin-top:10px;width:200px}.preview img{width:100%;height:auto}.progress{display:flex;flex-flow:row;align-items:center}.delete-img{cursor:pointer;border:none;box-sizing:inherit;background:0 0;padding:5px;margin:5px;min-width:auto}</style><div class="upload-wrapper"><paper-button class="upload-button" on-tap="_openDialog">Upload Icon</paper-button><input type="file" id="fileInput" on-change="_fileChange" hidden><div class="preview" hidden$="[[_hidePreview(uploadProgress)]]"><img id="preview"><div class="progress"><paper-progress id="progress" value="[[uploadProgress]]"></paper-progress><paper-button type="button" title="Delete Image" class="delete-img" on-click="_deleteImage"><iron-icon icon="icons:close"></iron-icon></paper-button></div></div></div></template><script>Polymer({
      is: 'polymer-dropzone',
      behaviors: [__state__],
      properties: {
        user: {
          type: Object
        },
        path: {
          type: Object
        },
        uploadProgress: {
          type: Number,
          value: 0
        }
      },
      ready: function(){

      },
      _hidePreview: function(uploadProgress){
        return !uploadProgress;
      },
      _deleteImage: function(e){
        this.imageRef.delete().then(d=>{
          this.uploadProgress = 0;
          this.$.preview.src = '';
          this.fire('image-deleted');
        })

      },
      _fileChange: function(e){
        if(!this.user){
          console.warn('no user specified.');
          return;
        }
        if(!this.path){
          console.warn('no path specified.');
          return;
        }
        var file = e.target.files[0];
        var reader  = new FileReader();

        reader.addEventListener("load", ()=>{
          this.$.preview.src = reader.result;
        }, false);

        if (file) {
          reader.readAsDataURL(file);
        }

        // Create a root reference
        var storageRef = firebase.storage().ref();
        var uuid = window.UUID();
        // Create a reference to 'images/mountains.jpg'
        var imageRef = storageRef.child(`${this.path}/${uuid}-${file.name}`);
        this.imageRef = imageRef;
        var uploadTask = imageRef.put(file);
        uploadTask.on('state_changed', snapshot => {
          // Observe state change events such as progress, pause, and resume
          // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
          var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          this.set('uploadProgress',progress);
          console.log('Upload is ' + progress + '% done');
          switch (snapshot.state) {
            case firebase.storage.TaskState.PAUSED: // or 'paused'
              console.log('Upload is paused');
              break;
            case firebase.storage.TaskState.RUNNING: // or 'running'
              console.log('Upload is running');
              break;
          }
        }, error => {
          // Handle unsuccessful uploads
        }, () => {
          // Handle successful uploads on complete
          // For instance, get the download URL: https://firebasestorage.googleapis.com/...
          var downloadURL = uploadTask.snapshot.downloadURL;
          this.fire('image-uploaded', {downloadURL, file});
        });
      },
      _openDialog: function(){
        var elem = this.$.fileInput;
        if (elem && document.createEvent) { // sanity check
          var evt = document.createEvent("MouseEvents");
          evt.initEvent("click", true, false);
          elem.dispatchEvent(evt);
        }
      },
      attached: function(){
        if (window.File && window.FileReader && window.FileList && window.Blob) {
          // Great success! All the File APIs are supported.
        } else {
          alert('The File APIs are not fully supported in this browser.');
        }
      },

    });</script></dom-module>